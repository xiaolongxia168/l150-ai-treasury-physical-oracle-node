# ClawVid — Project Structure Design

**Date:** 2026-02-11
**Status:** Approved

## Overview

ClawVid is an OpenClaw skill for AI-powered short-form video generation. The OpenClaw agent orchestrates the full pipeline — scene planning, asset generation via fal.ai, composition via Remotion, and post-production via FFmpeg. Outputs in both YouTube (16:9) and social media (9:16) formats from a single run.

## Top-Level Structure

```
clawvid/
├── src/                        # All source code
├── tests/                      # Mirrors src/ structure
├── workflows/                  # Example workflow JSONs
├── output/                     # Generated assets per run (gitignored)
├── docs/
│   └── plans/                  # Design documents
├── package.json
├── tsconfig.json
├── .env.example
├── .gitignore
├── config.json                 # All tuneable settings (single source of truth)
├── preferences.json            # Per-user creative defaults (generated by setup)
├── README.md
└── SKILL.md                    # OpenClaw agent behavior rules only
```

## Configuration — Separation of Concerns

Three files, each with a single job:

| File | Purpose | Who edits it |
|---|---|---|
| `SKILL.md` | Agent behavior rules — how to think, plan, decide | Developer (rare) |
| `config.json` | All tuneable settings — models, templates, platforms, encoding | Human or AI (frequent) |
| `preferences.json` | Per-user creative defaults — generated by `clawvid setup` | Generated by CLI |

**Priority chain:** `preferences.json` > `config.json` > hardcoded defaults in `src/config/defaults.ts`

### config.json

```json
{
  "fal": {
    "image": {
      "default": "fal-ai/flux/dev",
      "premium": "fal-ai/flux-pro/v1.1",
      "stylized": "fal-ai/grok-imagine"
    },
    "video": {
      "default": "fal-ai/kling-video/v1.5/pro/image-to-video",
      "fast": "fal-ai/minimax-video/image-to-video",
      "cinematic": "fal-ai/luma-dream-machine"
    },
    "audio": {
      "tts": "fal-ai/f5-tts",
      "transcription": "fal-ai/whisper"
    }
  },

  "defaults": {
    "aspect_ratio": "9:16",
    "resolution": { "width": 1080, "height": 1920 },
    "fps": 30,
    "duration_seconds": 60,
    "max_video_clips": 3,
    "image_to_video_ratio": 0.75
  },

  "templates": {
    "horror": {
      "image_model": "premium",
      "video_model": "default",
      "color_mood": "dark_desaturated",
      "effects": ["vignette", "grain", "flicker"],
      "voice_style": "deep_slow",
      "voice_pacing": 0.9,
      "scenes_per_minute": 7
    },
    "motivation": {
      "image_model": "default",
      "video_model": "cinematic",
      "color_mood": "warm_golden",
      "effects": ["lens_flare", "fade"],
      "voice_style": "warm_confident",
      "voice_pacing": 1.0,
      "scenes_per_minute": 5
    },
    "quiz": {
      "image_model": "stylized",
      "video_model": "fast",
      "color_mood": "bright_vibrant",
      "effects": ["timer", "reveal"],
      "voice_style": "energetic_clear",
      "voice_pacing": 1.1,
      "scenes_per_minute": 8
    },
    "reddit": {
      "image_model": "default",
      "video_model": "fast",
      "color_mood": "neutral",
      "effects": ["post_card_overlay"],
      "voice_style": "casual_conversational",
      "voice_pacing": 1.0,
      "scenes_per_minute": 6
    }
  },

  "quality": {
    "max_quality": {
      "image_model": "premium",
      "image_size": "landscape_16_9",
      "video_clips": 3,
      "inference_steps": 50
    },
    "balanced": {
      "image_model": "default",
      "image_size": "landscape_16_9",
      "video_clips": 2,
      "inference_steps": 28
    },
    "budget": {
      "image_model": "default",
      "image_size": "square",
      "video_clips": 1,
      "inference_steps": 20
    }
  },

  "platforms": {
    "youtube": {
      "aspect_ratio": "16:9",
      "resolution": { "width": 1920, "height": 1080 },
      "max_duration_seconds": 60,
      "codec": "h264",
      "audio_codec": "aac",
      "bitrate": "8M",
      "audio_bitrate": "192k"
    },
    "tiktok": {
      "aspect_ratio": "9:16",
      "resolution": { "width": 1080, "height": 1920 },
      "max_duration_seconds": 60,
      "codec": "h264",
      "audio_codec": "aac",
      "bitrate": "6M",
      "audio_bitrate": "128k"
    },
    "instagram_reels": {
      "aspect_ratio": "9:16",
      "resolution": { "width": 1080, "height": 1920 },
      "max_duration_seconds": 90,
      "codec": "h264",
      "audio_codec": "aac",
      "bitrate": "6M",
      "audio_bitrate": "128k"
    }
  },

  "output": {
    "directory": "output",
    "format": "mp4",
    "codec": "h264",
    "naming": "{date}-{slug}"
  }
}
```

### preferences.json

```json
{
  "platforms": ["youtube_shorts", "tiktok"],
  "template": "horror",
  "quality_mode": "balanced",
  "voice": {
    "style": "ai_male_deep",
    "pacing": 0.9
  },
  "visual_style": "cinematic",
  "created_at": "2026-02-11",
  "updated_at": "2026-02-11"
}
```

## Source Code Structure

```
src/
├── index.ts                          # Entry point — wires CLI and exports
│
├── cli/                              # One file per command
│   ├── program.ts                    # Commander program setup + global options
│   ├── generate.ts                   # clawvid generate
│   ├── render.ts                     # clawvid render
│   ├── preview.ts                    # clawvid preview
│   ├── studio.ts                     # clawvid studio (launches Remotion)
│   └── setup.ts                      # clawvid setup (writes preferences.json)
│
├── core/                             # Pipeline orchestration
│   ├── pipeline.ts                   # Top-level: plan > generate > compose > render
│   ├── scene-planner.ts              # Breaks content into timed scene list
│   ├── workflow-runner.ts            # Reads workflow JSON, executes steps in order
│   └── asset-manager.ts              # Tracks assets per run (paths, metadata, status)
│
├── fal/                              # fal.ai API layer
│   ├── client.ts                     # Shared client (auth, retry, errors)
│   ├── image.ts                      # text-to-image, image-to-image
│   ├── video.ts                      # image-to-video
│   ├── audio.ts                      # TTS + transcription
│   ├── queue.ts                      # p-queue wrapper, rate limiting, concurrency
│   ├── cost.ts                       # Track API costs per run
│   └── types.ts                      # Request/response types for all fal endpoints
│
├── render/                           # Remotion video composition
│   ├── root.tsx                      # Remotion registerRoot entry
│   ├── renderer.ts                   # Programmatic render API (bundle + render)
│   ├── compositions/
│   │   ├── landscape.tsx             # 16:9 YouTube composition
│   │   └── portrait.tsx              # 9:16 Social composition
│   ├── layouts/                      # Platform-aware framing
│   │   ├── landscape-frame.tsx       # Safe zones, text placement for 16:9
│   │   └── portrait-frame.tsx        # Safe zones, text placement for 9:16
│   ├── templates/                    # One file per template style
│   │   ├── horror.tsx
│   │   ├── motivation.tsx
│   │   ├── quiz.tsx
│   │   └── reddit.tsx
│   ├── effects/                      # Composable visual effects
│   │   ├── vignette.tsx
│   │   ├── grain.tsx
│   │   ├── ken-burns.tsx
│   │   ├── glitch.tsx
│   │   ├── flicker.tsx
│   │   └── chromatic-aberration.tsx
│   └── components/                   # Shared scene building blocks
│       ├── subtitle.tsx
│       ├── scene-image.tsx
│       ├── scene-video.tsx
│       └── transition.tsx
│
├── post/                             # Post-production (after Remotion render)
│   ├── ffmpeg.ts                     # FFmpeg wrapper (core operations)
│   ├── encoder.ts                    # Platform-specific encoding profiles
│   └── thumbnail.ts                  # Extract best frame as thumbnail
│
├── audio/                            # Audio processing
│   ├── mixer.ts                      # Mix narration + music + SFX
│   ├── normalize.ts                  # LUFS normalization
│   └── silence.ts                    # Trim silence from TTS output
│
├── subtitles/                        # Subtitle generation
│   ├── generator.ts                  # Generate SRT/VTT from timing data
│   └── word-timing.ts                # Word-level timing from Whisper
│
├── validation/                       # Validate generated assets
│   ├── image.ts                      # Check dimensions, format, file integrity
│   ├── video.ts                      # Check duration, resolution, codec
│   ├── audio.ts                      # Check duration, sample rate, silence
│   └── consistency.ts                # Color/style consistency across scenes
│
├── cache/                            # Don't regenerate unchanged steps
│   ├── store.ts                      # File-based cache (per-run asset tracking)
│   └── hash.ts                       # Hash workflow steps to detect changes
│
├── platforms/                        # Platform-specific specs
│   ├── types.ts                      # Platform type definitions
│   ├── youtube.ts                    # YouTube: 16:9, specs, metadata
│   ├── tiktok.ts                     # TikTok: 9:16, specs, limits
│   ├── instagram.ts                  # Reels: 9:16, specs, limits
│   └── profiles.ts                   # Encoding profiles per platform
│
├── schemas/                          # Zod validation schemas
│   ├── config.ts                     # Validates config.json
│   ├── preferences.ts                # Validates preferences.json
│   ├── workflow.ts                   # Validates workflow JSON
│   └── scene.ts                      # Validates scene definitions
│
├── config/                           # Config loading + merging
│   ├── loader.ts                     # Reads config.json + preferences.json, merges
│   └── defaults.ts                   # Hardcoded fallback values
│
└── utils/                            # Small, focused helpers
    ├── logger.ts                     # Structured logging (pino)
    ├── files.ts                      # Read/write JSON, ensure directories
    ├── slug.ts                       # "Haunted Library" > "haunted-library"
    ├── progress.ts                   # ora + cli-progress wrappers
    └── cost.ts                       # Format cost summaries
```

## Test Structure

```
tests/
├── cli/
│   ├── generate.test.ts
│   ├── render.test.ts
│   └── setup.test.ts
├── core/
│   ├── pipeline.test.ts
│   ├── scene-planner.test.ts
│   └── workflow-runner.test.ts
├── fal/
│   ├── client.test.ts
│   ├── image.test.ts
│   ├── video.test.ts
│   └── queue.test.ts
├── validation/
│   ├── image.test.ts
│   └── consistency.test.ts
├── schemas/
│   ├── config.test.ts
│   └── workflow.test.ts
└── cache/
    └── store.test.ts
```

## Dependencies

### Runtime

| Package | Purpose |
|---|---|
| `@fal-ai/client` | fal.ai API client |
| `commander` | CLI framework |
| `zod` | Runtime schema validation |
| `dotenv` | Environment variable management |
| `fluent-ffmpeg` | FFmpeg wrapper — audio mixing, encoding, thumbnails |
| `sharp` | Image processing — resize, crop, format, color analysis |
| `p-queue` | Concurrency control for API calls |
| `p-retry` | Retry failed API calls with exponential backoff |
| `execa` | Better subprocess control (FFmpeg, Remotion) |
| `file-type` | Verify generated files are valid images/videos |
| `probe-image-size` | Check image dimensions without loading full file |
| `get-video-duration` | Verify video clip lengths |
| `nanoid` | Unique IDs for pipeline runs |
| `chalk` | Colored terminal output |
| `ora` | Spinners for async operations |
| `cli-progress` | Progress bars for multi-step generation |
| `subtitle` | Generate SRT/VTT subtitle files |
| `pino` | Structured JSON logging |
| `eventemitter3` | Event-driven pipeline progress + hooks |
| `fs-extra` | Robust file operations |

### Remotion

| Package | Purpose |
|---|---|
| `remotion` | Core Remotion library |
| `@remotion/renderer` | Programmatic rendering |
| `@remotion/cli` | Remotion studio for preview |

### Dev

| Package | Purpose |
|---|---|
| `typescript` | TypeScript compiler |
| `tsx` | TypeScript execution (dev mode) |
| `vitest` | Testing framework |
| `@types/node` | Node.js type definitions |
| `@types/fluent-ffmpeg` | FFmpeg types |

## Pipeline Flow

```
CLI command (clawvid generate --workflow horror.json)
  |
  v
Load config.json + preferences.json (config/loader.ts)
  |
  v
Check cache — skip unchanged steps (cache/store.ts)
  |
  v
Generate assets via fal.ai (fal/)
  - Concurrency-controlled queue (fal/queue.ts)
  - Retry on failure (p-retry)
  - Cost tracking (fal/cost.ts)
  |
  v
Validate each asset (validation/)
  - Dimensions, duration, format, integrity
  - Color/style consistency across scenes
  |
  v
Cache results (cache/store.ts)
  |
  v
Audio processing (audio/)
  - Trim TTS silence
  - Normalize to target LUFS
  - Mix narration + background music + SFX
  |
  v
Generate subtitles (subtitles/)
  - Word-level timing from Whisper
  - Output SRT/VTT files
  |
  v
Remotion render (render/)
  - Landscape composition (16:9 YouTube)
  - Portrait composition (9:16 Social)
  - Template effects applied per style
  |
  v
FFmpeg post-production (post/)
  - Platform-specific encoding
  - Thumbnail extraction
  |
  v
Output
  output/{date}-{slug}/
  ├── assets/          # Raw generated assets
  ├── youtube/
  │   ├── final.mp4
  │   ├── thumbnail.jpg
  │   └── subtitles.srt
  ├── tiktok/
  │   ├── final.mp4
  │   ├── thumbnail.jpg
  │   └── subtitles.srt
  ├── workflow.json    # Full workflow record
  └── cost.json        # API cost breakdown
```

## Output Structure Per Run

```
output/
└── 2026-02-11-haunted-library/
    ├── assets/
    │   ├── scene-01.png
    │   ├── scene-02.mp4
    │   ├── scene-03.png
    │   ├── narration.mp3
    │   └── music.mp3
    ├── youtube/
    │   ├── final.mp4
    │   ├── thumbnail.jpg
    │   └── subtitles.srt
    ├── tiktok/
    │   ├── final.mp4
    │   ├── thumbnail.jpg
    │   └── subtitles.srt
    ├── instagram/
    │   ├── final.mp4
    │   ├── thumbnail.jpg
    │   └── subtitles.srt
    ├── workflow.json
    └── cost.json
```

## Naming Conventions

- Files: `kebab-case.ts` — always
- Directories: `kebab-case/` — always
- One primary export per file where possible
- No `index.ts` barrel files except `src/index.ts`
- Explicit imports, no magic re-exports
- Tests mirror source: `src/fal/image.ts` -> `tests/fal/image.test.ts`

## Future Considerations

- Additional templates (educational, custom)
- Additional platforms (YouTube long-form, Twitter/X)
- Additional fal.ai models as they release
- Plugin system for custom effects
- Upload/distribution automation
- Analytics dashboard for cost tracking
- Batch processing (multiple videos in one run)
