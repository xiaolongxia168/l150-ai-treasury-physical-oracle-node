# 聊天窗口上下文救援计划

## 问题描述
当聊天窗口上下文使用率达到上限（64k）时，OpenClaw会假死，无法继续对话。

## 解决方案架构

### 1. 主动监控系统 ✅
- **Cron任务**: 每5分钟检查上下文使用率
- **阈值**: 90% (57.6k/64k) 触发警告，95% (60.8k/64k) 触发行动
- **监控命令**: `openclaw session status`

### 2. 状态保存机制
当检测到高使用率时，自动保存：
- 当前工作状态摘要
- 活跃项目列表
- 最近记忆文件
- Cron任务状态
- 系统状态

### 3. 无缝衔接策略
#### 新对话开启前：
1. **生成会话快照**: 保存当前所有重要信息
2. **创建延续标记**: 标记需要继续的任务
3. **准备重启脚本**: 自动加载之前的状态

#### 新对话开启后：
1. **加载快照**: 恢复工作上下文
2. **检查延续标记**: 继续未完成的任务
3. **验证系统状态**: 确保一切正常运行

### 4. 自动化流程
```bash
# 检测到高使用率 → 保存状态 → 通知用户 → 准备新对话 → 恢复工作
```

## 实施步骤

### 阶段1：监控与预警 ✅
- [x] 创建cron监控任务 (Chat-Context-Monitor)
- [x] 设置90%警告阈值
- [x] 设置95%行动阈值

### 阶段2：状态保存
- [ ] 创建状态快照脚本
- [ ] 设计延续标记格式
- [ ] 实现自动保存机制

### 阶段3：无缝恢复
- [ ] 创建状态加载脚本
- [ ] 实现任务延续逻辑
- [ ] 测试恢复流程

### 阶段4：完全自动化
- [ ] 集成所有组件
- [ ] 测试端到端流程
- [ ] 优化用户体验

## 紧急手动操作指南

如果系统已经假死，可以：

### 1. 强制保存当前状态
```bash
# 保存工作空间快照
cp -r /Users/xiaolongxia/.openclaw/workspace /tmp/workspace_backup_$(date +%Y%m%d_%H%M%S)

# 保存记忆文件
find /Users/xiaolongxia/.openclaw/workspace/memory -name "*.md" -exec cp {} /tmp/ \;
```

### 2. 重启OpenClaw
```bash
# 重启网关
openclaw gateway restart

# 或者完全重启
pkill -f openclaw
openclaw gateway start
```

### 3. 恢复工作
1. 开启新对话
2. 加载备份文件
3. 继续之前的工作

## 预防措施

### 日常维护
1. **定期清理**: 删除不必要的记忆文件
2. **压缩历史**: 将旧对话归档
3. **监控使用率**: 保持在80%以下

### 最佳实践
1. **重要信息写文件**: 不要依赖聊天历史
2. **使用子代理**: 复杂任务使用独立会话
3. **定期提交**: 工作空间变化及时提交到GitHub

## 技术细节

### 上下文使用率计算
- DeepSeek模型: 64k上下文
- 警告阈值: 57.6k (90%)
- 行动阈值: 60.8k (95%)
- 危险阈值: 63k (98%)

### 状态保存格式
```json
{
  "timestamp": "2026-02-14T01:18:00",
  "context_usage": "66%",
  "active_projects": ["L-150", "AI-Treasury"],
  "pending_tasks": ["邮件监控", "GitHub部署"],
  "memory_files": ["2026-02-13.md", "2026-02-14.md"],
  "cron_jobs": ["L-150-Email-Monitor", "Gateway-Health-Monitor"]
}
```

## 成功指标

1. **零假死**: 系统在达到上限前自动处理
2. **无缝恢复**: 用户几乎感觉不到中断
3. **状态完整**: 所有工作内容得到保存
4. **自动化程度**: 无需人工干预

---

**最后更新**: 2026-02-14 01:20 GMT+8
**状态**: 阶段1完成，监控系统已部署
**下一步**: 实现状态保存机制